# Base Containerfile for Debcraft
FROM debian:sid

ENV DEBIAN_FRONTEND=noninteractive

RUN apt-get update && \
    apt-get install --yes --no-install-recommends \
    devscripts \
    equivs \
    curl \
    ccache \
    git \
    git-buildpackage \
    pristine-tar \
    eatmydata \
    lintian

# Delete 3 rows below
RUN update-ccache-symlinks
RUN mkdir --verbose --parents ccache
RUN ccache --show-stats

COPY control /
RUN DEBIAN_FRONTEND=noninteractive mk-build-deps -r -i /control \
    -t 'apt-get -y -o Debug::pkgProblemResolver=yes --no-install-recommends'

# The installation of /usr/lib/ccache symlinks must be created after
# installation of GCC et al to properly take effect
RUN mkdir --verbose --parents ccache
RUN update-ccache-symlinks
RUN ls -la /usr/lib/ccache

# Older ccache does not support '--verbose' but will print stats anyway, just
# followed by help section. Newer ccache 4.0+ (Ubuntu 22.04 "Focal", Debian 12
# "Bullseye") however require '--verbose' to show any cache hit stats at all.
RUN ccache --show-stats  --verbose || true

COPY debcraft-builder.sh /debcraft-builder
COPY debcraft-validator.sh /debcraft-validator
COPY debcraft-releaser.sh /debcraft-releaser
RUN chmod +x /debcraft-*
